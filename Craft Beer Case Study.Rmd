---
title: "Craft Beers"
author: "Linda Eliasen/Limin Zheng"
date: "February 23, 2019"
output: html_document
---

```{r setup, include=FALSE}
# Setting our Echo on output for the presentation to be false
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```


```{r libraries, include=FALSE}
library(cowplot)
library(dplyr)
library(tidyr)
library(knitr)
library(readr)
library(ggplot2)
library(ggthemes)
library(ggpubr)
library(stringr)
library(kableExtra)
library(highcharter)
library(dataMaid)
```

## bringing in data files
```{r files}
#Load brew.csv dataset, name as breweries
breweries<- read.csv("breweries.csv" , header=TRUE, stringsAsFactors=FALSE)
#Rename columns
colnames(breweries)<- c('Brewery_id', 'Name', 'City', 'State')
#Load beer.csv dataset
beer <- read.csv("beers.csv" , header=TRUE, stringsAsFactors=FALSE)
#Outer merge beer and brew into object brew.
brew<-merge(breweries,beer, by="Brewery_id",all.x = TRUE)
#Rename columns
colnames(brew)<- c('Brewery_id', 'Brewery', 'City', 'State', 'Beer', 'Beer_ID', 'ABV', 'IBU', 'Style', 'Ounces')
#Change values in IBU column to numeric
brew$IBU <- as.numeric(brew$IBU)
#Find economic beer data from internet and read into dataframe sbystate
sbystate <- read.csv("StateStats.csv" , header=TRUE, sep = ",", stringsAsFactors=FALSE)
#Change values in following columns into numeric
sbystate$Economic.Impact.Mil<-as.numeric(sbystate$Economic.Impact.Mil)
sbystate$Economic.Impact.Rank<-as.numeric(sbystate$Economic.Impact.Rank)
sbystate$Barrels.Per.Year<-as.numeric(sbystate$Barrels.Per.Year)
```


Top and Bottom of Brewery Data Set

```{r head}
#Select the columns
 brew <- brew %>%
   select(Brewery, Beer, Style, ABV, IBU, Ounces, City, State, Beer_ID, Brewery_id)
# Print the top 6 rows of combined dataframe
kable(head(brew,6))%>%
  kable_styling(full_width = F)
```

```{r tail}
#Print the last 6 rows of combined dataframe
kable(tail(brew,6))%>%
  kable_styling(full_width = F)
```


Report the number of NA's in each column.
```{r missing}
#Report the missing NAs in each column
sha<-colSums(is.na(brew))
 kable(sha)%>%
   kable_styling(full_width = F)
```

CRAFT BEER DEMOGRAPHICS BY STATE
How many breweries are present in each state? Compute the median alcohol content and international bitterness unit for each state, plus adding in other data elements from third file
```{r facts}
#Calculate how many breweries in each state. Calculate the median ABV and median IBU in each state, combine them into the same dataframe called brew.state.
brew.state <-as.data.frame(brew%>% group_by(State) 
  %>% summarise(MedianABV=median(ABV, na.rm=TRUE), 
  MedianIBU=median(IBU, na.rm=TRUE),
 Breweries = n_distinct(Brewery_id)))
#Change column Breweries to numeric.
brew.state$Breweries<- as.numeric(brew.state$Breweries)
#Merge brew.state dataset with the economic beer data into one dataframe, called brew.state
brew.state<-merge(brew.state, sbystate, by="State",all.x = TRUE)
#Rename the columns in brew.state dataframe
colnames(brew.state)<- c('State', 'MedianABV', 'MedianIBU', 'Breweries','BreweriesPerCapita', 'EconomicImpactM$', 'EconomicImpactRank', 'BarrelsPerYear', 'GallonsPerAdult')
########Stylish the brew.state table in HTML,I think we do not need to print out the table#########
brew.state.html <-
kable(brew.state)%>%
kable_styling(bootstrap_options = "striped", full_width = T)
#write out csv file
write.csv(brew.state, "brew.state.csv")
```


Heat map number of breweries by state
```{r mapBreweries}
#Get states map data
mapdata <- get_data_from_map(download_map_data("countries/us/us-all"))
#Need to remove extra spaces from state abreviation
brew.state$State <- str_trim(brew.state$State,side="left")
brew.state <- brew.state %>% mutate(`hc-a2`= State);
#Plot the heat map of breweries by state
hcmap("countries/us/us-all", data = brew.state, value = "Breweries",
	  joinBy = "hc-a2", name = "Breweries",
	  dataLabels = list(enabled = TRUE, format = '{point.name}'),
	  borderColor = "#FAFAFA", borderWidth = 0.1,
	  tooltip = list(valueDecimals = 0,valueSuffix = " Breweries")) %>%
	hc_mapNavigation(enabled = TRUE) %>%
	hc_title(text = "<b>Number of Breweries by State</b>",
			 margin = 20, align = "center", 
			 style = list(color = "#000000", 
			 			 useHTML = TRUE))
#Print out the table of num. of brews by state
kable(brew.state[, c("Breweries", "State")])%>%
kable_styling( full_width = T)
```

Plot a bar chart to compare Median ABV and IBU by State
```{r echo=TRUE}
#Plot the bar chart to compare Median ABV and IBU by State. Note the missing IBU data in state SD
ggplot(brew.state, aes(x=reorder(State, -MedianABV),y=MedianABV, fill=MedianIBU))+labs(title="Plot of ABV by state", x="State", y="MedianABV", fill="median IBU")+geom_bar(stat="identity") + theme_bw() +theme(axis.text.x=element_text(angle=90, size = 7)) +theme(plot.title = element_text(hjust = 0.5))+theme(axis.text.y = element_text(hjust=1, vjust=0.5, size=5))+coord_flip()
```

charts side by side... still work in progress, want to turn into back to back
```{r abv_ibu}
#Graph side by side
#Median ABV bar chart
abv<-ggplot(brew.state, aes(x=reorder(State, -MedianABV), y=MedianABV, fill=MedianABV)) + 
  geom_bar(stat="identity") +
  labs(x="State",y="Median ABV") +
  ggtitle("Median ABV by State") +
  theme(plot.title = element_text(hjust = 0.5))+ 
  theme(axis.text.y = element_text(hjust=1, vjust=0.5, size=4.5))+
  theme(legend.position="bottom")+
  theme(legend.text = element_text(colour="black", size =6))+
  theme(legend.title = element_blank()) +
  coord_flip() 
#Median IBU bar char
ibu<-ggplot(brew.state, aes(x=reorder(State, -MedianIBU), y=MedianIBU, fill=MedianIBU)) + 
  geom_bar(stat="identity") +
  labs(x="State",y="Median IBU") +
  ggtitle("Median IBU by State") +
  theme(plot.title = element_text(hjust = 0.5))+ 
  theme(axis.text.y = element_text(hjust=1, vjust=0.5, size=4.5))+
  theme(legend.position="bottom")+
  theme(legend.text = element_text(colour="black", size =8))+
  theme(legend.title = element_blank()) +
  coord_flip()

plotf<-plot_grid(abv, ibu, align="hv", nrow = 1, ncol = 2) 

plotf
```


Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?
```{r max}
ma <- data.frame(brew[order(-brew$ABV),])
ma=ma[1,c(8,2,4,5)]
ma<-ma[1, ]
mi <- data.frame(brew[order(-brew$IBU),])
mi=mi[1,c(8,2,4,5)]
mi<-mi[1, ]

top<-rbind(ma, mi)
top[is.na(top)] <- ""

kable(head(top[,1:4]),
      format = "pandoc", 
      digits = 3,        
      caption = "State with Highest ABV and Most Bitter Beer",
      col.names = c("State","Beer","ABV","IBV"),
      row.names = FALSE,
      align = c("l"))  
```

Summary statistics for the ABV variable (also adding in IBU)
```{r summary}
Alcohol_by_Volume<-summary(brew$ABV, na.rm=TRUE, digits = 3)
International_Bitterness_Units<-summary(brew$IBU, na.rm=TRUE)

Economic_Impact_In_Millions<-summary(brew.state$`EconomicImpactM$`)#, digits=1)
Annual_Production_Barrels<-summary(brew.state$BarrelsPerYear)#, digits=0)

abv<-rbind(Alcohol_by_Volume, International_Bitterness_Units)
kable(abv)%>%
  kable_styling(full_width = F)


eco<-rbind(Economic_Impact_In_Millions, Annual_Production_Barrels)
kable(eco)%>%
  kable_styling(full_width = F)
```

Histogram with density plot ABV
```{r abvhist}
ggplot(brew, aes(x=ABV)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="lightblue", 
                position="identity")+
 	geom_density(alpha=.2, color="blue")+
	geom_vline(aes(xintercept=mean(brew$ABV, na.rm = T)), color="red",
             linetype="longdash")+
	labs(title="Alchohol by Volume",x="ABV", y = "Density")+
	geom_text(data=brew, mapping=aes(x=mean(brew$ABV, na.rm = T), y=50, label=round(mean(brew$ABV, na.rm = T),digits=4)), size=4, hjust=-0)
```


Histogram with density plot IBU
```{r ibuhist}
ggplot(brew, aes(x=IBU)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="lightblue", 
                position="identity")+
 	geom_density(alpha=.2, color="blue")+
	geom_vline(aes(xintercept=mean(brew$IBU, na.rm = T)), color="red",
             linetype="longdash")+
	labs(title="International Bitterness Unit",x="IBU", y = "Density")+
	geom_text(data=brew, mapping=aes(x=round(mean(brew$IBU, na.rm = T),digits=2), y=0.022, label=round(mean(brew$IBU, na.rm = T),digits=1)), size=4, hjust=0)
```


Is there an apparent relationship between the bitterness of the beer and its alcoholic content? 
```{r scatter}
ggplot(brew, aes(IBU, ABV)) +
geom_point(color="blue") +
xlim(0,150)+ylim(0,.150)+
  labs(x="IBU",y="ABV") +
ggtitle("Bitterness v. Alcohol Content") +
geom_smooth(method=lm, color="black", se=FALSE)

```


Treemap of Beer Styles
```{r tmapstyle}
brew%>%
  count(Style)%>%
  arrange(n)%>%
  hchart(type = "treemap", hcaes(x = Style, value = n, color = n))
```
ADDITIONAL CHARTS

Number of different craft beers in each state
```{r diffbeer}
btype<-as.data.frame(brew %>% group_by(State)
        %>% summarise(BeerTypes = n_distinct(Beer)))

btype<-btype[order(-btype$BeerTypes),]
kable(btype)%>%
  kable_styling(full_width = F)

ggplot(btype, aes(x=reorder(State, -BeerTypes), y=BeerTypes, fill=BeerTypes)) + 
  geom_bar(stat="identity") +
  labs(x="State",y="Number") +
  ggtitle("Number of Different Craft Beers by State") +
  theme(plot.title = element_text(hjust = 0.5))+ 
  theme(axis.text.y = element_text(hjust=1, vjust=0.5, size=5))+
  coord_flip()

```


Number of different beer STYLES in each state
```{r style}

bstyl<-as.data.frame(brew %>% group_by(State)%>% summarise(BeerStyles=n_distinct(Style)))
bstyl<-bstyl[order(-bstyl$BeerStyles),]

kable(bstyl)%>%
  kable_styling(full_width = F)


ggplot(bstyl, aes(x=reorder(State, -BeerStyles), y=BeerStyles, fill=BeerStyles)) + 
  geom_bar(stat="identity") +
  labs(x="State",y="Number") +
  ggtitle("Number of Different Beer Styles by State") +
  theme(plot.title = element_text(hjust = 0.5))+ #forces centering
  theme(axis.text.y = element_text(hjust=1, vjust=0.5, size=5))+
  coord_flip()
```

Median ABV and IBU by Craft Beer Style
```{r}
medstyl <-as.data.frame(brew%>% group_by(Style) 
  %>% summarise(MedianABV=median(ABV, na.rm=TRUE), 
  MedianIBU=median(IBU, na.rm=TRUE)))

medstyl <- medstyl[-1,]

medstyl<-medstyl[order(-medstyl$MedianABV),]

kable(medstyl)%>%
  kable_styling(full_width = F)
```



Beer and Brand Style by State
```{r brndstyl}
BrndStyl <- merge(btype, bstyl, by='State')
BrndStyl<-BrndStyl[order(-BrndStyl$BeerStyles),]

kable(BrndStyl)%>%
  kable_styling(full_width = F)

```





```{r }
statesum<-merge(state, BrndStyl, by="State",all.x = TRUE)
colnames(statesum)<- c('State', 'MedianABV', 'MedianIBU', 'Breweries','BreweriesPerCapita', 'EconomicImpactMil', 'EconomicImpactRank', 'BarrelsPerYear', 'GallonsPerAdult', 'DifferentTypes', 'DifferentStyles')

statesum<-statesum[,c(1,2,3,4,10,11,5,6,7,8,9)]

#kable(statesum)%>%
#  kable_styling(full_width = F)

```

State Top 10 Rank by Economic Impact
```{r rank}
rankei<-statesum[order(-statesum$EconomicImpactRank),]
rankei=rankei[,c(1,9)]

kable(head(rankei,10))%>%
  kable_styling(full_width = F)

```

Revenue by State in M$
```{r rev}
rev<-statesum[order(-statesum$EconomicImpactMil),]
rev=rev[,c(1,8)]

kable(head(rev,10))%>%
  kable_styling(full_width = F)

ggplot(rev, aes(x=reorder(State, -EconomicImpactMil), y=EconomicImpactMil, fill=EconomicImpactMil)) + 
  geom_bar(stat="identity") +
  labs(x="State",y="Revenue in M$") +
  ggtitle("Craft Beer Revenue M$ by State") +
  theme(plot.title = element_text(hjust = 0.5))+ #forces centering
  theme(axis.text.y = element_text(hjust=1, vjust=0.5, size=5))+
  coord_flip()

```


Gallons Per Adult 21+ by State
```{r gallon}
cons<-statesum[order(-statesum$GallonsPerAdult),]
cons=cons[,c(1,11)]

kable(head(cons,10))%>%
  kable_styling(full_width = F)

ggplot(cons, aes(x=reorder(State, -GallonsPerAdult), y=GallonsPerAdult, fill=GallonsPerAdult)) + 
  geom_bar(stat="identity") +
  labs(x="State",y="Gallons") +
  ggtitle("Gallons Produced Per Adult by State") +
  theme(plot.title = element_text(hjust = 0.5))+ 
  theme(axis.text.y = element_text(hjust=1, vjust=0.5, size=5))+
  coord_flip()

```

write.csv(statesum,'statesum.csv')

#####Sources
*https://www.datacamp.com/community/tutorials/data-visualization-highcharter-r*
*http://www.sthda.com/english/wiki/ggplot2-density-plot-quick-start-guide-r-software-and-data-visualization*
*https://rpubs.com/haozhu233/kableExtra_HTML*
